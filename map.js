var map=L.map('map',{zoomControl:false}).setView([11.759852,107.418673],8);const satellite=L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{attribution:'Imagery &copy; <a href="https://www.esri.com/">Esri</a>',maxZoom:28,});const esriOcean=L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Ocean/World_Ocean_Base/MapServer/tile/{z}/{y}/{x}',{attribution:'Tiles &copy; Esri &mdash; Source: Esri, DeLorme, GEBCO, NOAA NGDC, and other contributors',maxZoom:28,});const cartoVoyager=L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}.png',{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',maxZoom:28,});const basemaps={"Satellite Imagery":satellite,"Street":cartoVoyager,"Ocean":esriOcean};esriOcean.addTo(map);function updateBaseLayer(){const zoomLevel=map.getZoom();map.eachLayer(function(layer){if(layer instanceof L.TileLayer&&layer!==satellite&&!(layer instanceof L.MarkerClusterGroup)){map.removeLayer(layer);}});if(zoomLevel>10){cartoVoyager.addTo(map);}else{esriOcean.addTo(map);}}
map.on('zoomend',function(){if(!map.hasLayer(satellite)){updateBaseLayer();}});var customIcon=L.icon({iconUrl:'https://i.ibb.co/bWhk7NN/gps-shadow.png',});L.control.scale({metric:true,imperial:true,position:'bottomleft'}).addTo(map);function returnToDefaultExtent(){map.setView([11.759852,107.418673],8);}
window.updateMainMapBasemap=function(newBasemap){map.eachLayer(function(layer){if(layer instanceof L.TileLayer){map.removeLayer(layer);}});switch(newBasemap){case'satellite':satellite.addTo(map);break;case'street':cartoVoyager.addTo(map);break;case'ocean':esriOcean.addTo(map);break;}
};document.getElementById('homeButton').addEventListener('click',returnToDefaultExtent);L.control.scale({metric:true,imperial:true,position:'bottomleft'}).addTo(map);function returnToDefaultExtent(){map.setView([11.759852,107.418673],8);}
const markers=L.markerClusterGroup();function initializeMap(){map.addLayer(markers);setupEventListeners();}
function setupEventListeners(){document.addEventListener('locationSelected',handleLocationSelected);document.addEventListener('locationsFound',handleLocationsFound);}
function handleLocationSelected(event){const location=event.detail;displayLocationsOnMap([location]);}
function handleLocationsFound(event){const locations=event.detail;displayLocationsOnMap(locations);}
function zoomToMarker(lat,lng){map.flyTo([lat,lng],18,{animate:true,duration:1.5,});}
function displayLocationsOnMap(locations){markers.clearLayers();locations.forEach(location=>{const popupContent=`
            <p>
            <img src="${farmThumbnail}" alt="Farm Image" style="width:100%; height:auto; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); border-radius: 5px;">
            </p>
            <p>
            <b>Farm name:</b> ${location.farmname}<br>
            <b>Region name:</b> ${location.region_name}
            </p>`;const marker=L.marker([location.lat,location.long],{icon:customIcon}).bindPopup(popupContent);markers.addLayer(marker);});if(locations.length===1){zoomToMarker(locations[0].lat,locations[0].long);setTimeout(()=>{markers.getLayers()[0].openPopup();},1600);}else{const bounds=markers.getBounds();map.flyToBounds(bounds,{duration:1,maxZoom:15,easeLinearity:0.5,paddingTopLeft:[50,50],paddingBottomRight:[50,50]});}}
document.addEventListener('DOMContentLoaded',initializeMap);