<!DOCTYPE html><html lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width, initial-scale=1.0"><link rel=stylesheet href=./login.css><title>Login to enfarm Enterprise Platform</title><link rel=icon href=https://i.ibb.co/tQDxF41/enfarm-favicon.png type=image/png><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Be+Vietnam:wght@400;500;700&display=swap"><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"><script src=https://kit.fontawesome.com/0eb73cfc5c.js crossorigin=anonymous></script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css></head><body onload=loadPage()><div class=form-container><img src=https://enfarm.com/fd57352e4cea98b4c1fb.jpg alt="enCity Logo" class=company-logo><p class=title data-translate=Welcome>Welcome</p><h6 class=sub-title data-translate="Login to access the enfarm Enterprise Platform">Login to access the enfarm Enterprise Platform</h6><br><form class=form onsubmit="event.preventDefault(); loginWithPhoneNumber();"><input type=tel id=phone class=input name=phone data-translate="Mobile Number" placeholder="Mobile Number"><div class=otp-input-container><div class=otp-boxes><input type=text class=otp-box maxlength=1 oninput="moveToNext(this, 0)" onkeydown="handleKeyDown(event, this, 0)"><input type=text class=otp-box maxlength=1 oninput="moveToNext(this, 1)" onkeydown="handleKeyDown(event, this, 1)"><input type=text class=otp-box maxlength=1 oninput="moveToNext(this, 2)" onkeydown="handleKeyDown(event, this, 2)"><input type=text class=otp-box maxlength=1 oninput="moveToNext(this, 3)" onkeydown="handleKeyDown(event, this, 3)"><input type=text class=otp-box maxlength=1 oninput="moveToNext(this, 4)" onkeydown="handleKeyDown(event, this, 4)"><input type=text class=otp-box maxlength=1 oninput="moveToNext(this, 5)" onkeydown="handleKeyDown(event, this, 5)"></div><button type=button id=send-otp class=otp-btn onclick=handleSendOtp() data-translate="Send OTP">Send OTP</button></div><p id=error-message class=error-message></p><button type=submit class=form-btn data-translate="Log in">Log in</button></form></div><button id=lang-switch class=lang-switch onclick=toggleLanguage() aria-label="Toggle Language"> VN <i class="fa-solid fa-earth-asia"></i><span class=tooltip-bottom data-translate="Switch Language"></span></button><div id=modal class=modal><div class=modal-content><p id=modal-message></p><button onclick=closeModal()>OK</button></div></div><script>
//Login modal
function loginSuccess(accessToken, userId) {
    localStorage.setItem('accessToken', `Bearer ${accessToken}`);
    localStorage.setItem('userId', userId);
    showMessage('Đăng nhập thành công!');
    
    // Show modal with user ID
    document.getElementById('modal-message').textContent = `Đăng nhập thành công! User ID: ${userId}`;
    document.getElementById('modal').style.display = 'block';
}

function closeModal() {
    document.getElementById('modal').style.display = 'none';
    // Redirect to map.html after closing the modal
    window.location.href = 'map.html';
}


        let currentLang = 'vi';
        const PHONE_TEST = ['0988515341', '0787989900', '0399043123', '0399058122', '0938239553', '055957790', '0905568999'];
        const TEST_PHONE_OTP = '123456';
        let currentOTP = '';
        let user = null;

        const translations = {
            'en': {
                'Welcome': 'Welcome',
                'Login to access the enfarm Enterprise Platform': 'Login to access the enfarm Enterprise Platform',
                'Log in': 'Log in',
                'Switch Language': 'Switch Language',
                'Mobile Number': 'Mobile Number',
                'Send OTP': 'Send OTP'
            },
            'vi': {
                'Welcome': 'Chào mừng',
                'Login to access the enfarm Enterprise Platform': 'Đăng nhập để truy cập vào nền tảng doanh nghiệp enfarm',
                'Log in': 'Đăng nhập',
                'Switch Language': 'Đổi ngôn ngữ',
                'Mobile Number': 'Số điện thoại',
                'Send OTP': 'Gửi mã OTP'
            }
        };

        function loadPage() {
            const urlParams = new URLSearchParams(window.location.search);
            const langParam = urlParams.get('lang');
            if (langParam && (langParam === 'en' || langParam === 'vi')) {
                currentLang = langParam;
            }
            translatePageTo(currentLang);
        }

        function toggleLanguage() {
            currentLang = currentLang === 'en' ? 'vi' : 'en';
            translatePageTo(currentLang);
            const url = new URL(window.location);
            url.searchParams.set('lang', currentLang);
            window.history.pushState({}, '', url);
        }

        function translatePageTo(lang) {
            const elements = document.querySelectorAll('[data-translate]');
            const langSwitchButton = document.getElementById('lang-switch');

            langSwitchButton.innerHTML = lang === 'en' ? 'VN <i class="fa-solid fa-earth-asia"></i>' : 'EN <i class="fa-solid fa-earth-americas"></i>';

            elements.forEach(element => {
                const key = element.getAttribute('data-translate');
                if (element.tagName === 'INPUT') {
                    element.placeholder = translations[lang][key] || element.placeholder;
                } else {
                    element.innerText = translations[lang][key] || element.innerText;
                }
            });
        }

        function moveToNext(field, index) {
            if (field.value.length >= field.maxLength) {
                if (index < 5) {
                    document.getElementsByClassName('otp-box')[index + 1].focus();
                }
            }
        }

        //Allow users to backspace normally without having to manually move between boxes.
        function handleKeyDown(event, field, index) {
            if (event.key === 'Backspace') {
                event.preventDefault();
                if (field.value.length > 0) {
                    field.value = '';
                } else if (index > 0) {
                    const previousField = document.getElementsByClassName('otp-box')[index - 1];
                    previousField.focus();
                    previousField.value = '';
                }
            }
        }

        async function handleSendOtp() {
            const phoneNumber = document.getElementById('phone').value;
            try {
                const res = await getTokenByPhone(phoneNumber);
                if (res.status_code !== 200) {
                    showError('Có lỗi xảy ra, vui lòng thử lại sau!');
                    return;
                }
                if (res.content && res.content.length === 0) {
                    showError('* Số điện thoại này chưa được đăng ký. Vui lòng chọn đăng ký');
                    return;
                }
                const userData = res.content[0] ?? [];
                user = { userId: userData[0], accessToken: userData[1] };

                console.log('User ID:', user.userId); // Log the user ID

                // Simulating OTP generation and sending
                currentOTP = Math.floor(100000 + Math.random() * 900000).toString();
                showMessage(`Mã OTP đã được gửi đến số điện thoại ${phoneNumber}, vui lòng xác nhận OTP để tiếp tục!`);

                // Start countdown
                document.getElementById('send-otp').disabled = true;
                setTimeout(() => {
                    document.getElementById('send-otp').disabled = false;
                }, 60000);
            } catch (e) {
                console.log('Error', e);
                showError('Có lỗi xảy ra, vui lòng thử lại sau!');
            }
        }

        // Simulated API function with phone number to user ID mapping
        async function getTokenByPhone(phone) {
            // This should be replaced with actual API call
            return new Promise(resolve => {
                setTimeout(() => {
                    const phoneToUserIdMap = {
                        '0988515341': 'user236',
                        '0787989900': 'user260',
                        '0399043123': 'user261',
                        '0399058122': 'user990',
                        '0938239553': 'user991',
                        '055957790': 'user992',
                        '0905568999': 'user993'
                    };

                    const userId = phoneToUserIdMap[phone];
                    if (userId) {
                        resolve({
                            status_code: 200,
                            content: [[userId, `token_${userId}`]]
                        });
                    } else {
                        resolve({
                            status_code: 200,
                            content: []
                        });
                    }
                }, 1000);
            });
        }

        async function loginWithPhoneNumber() {
            const phoneNumber = document.getElementById('phone').value;
            const otpBoxes = document.getElementsByClassName('otp-box');
            const otp = Array.from(otpBoxes).map(box => box.value).join('');

            try {
                if (PHONE_TEST.includes(phoneNumber) && otp === TEST_PHONE_OTP) {
                    // Simulating login for test phones
                    const res = await getTokenByPhone(phoneNumber);
                    if (res.status_code !== 200 || (res.content && res.content.length === 0)) {
                        showError('Đăng nhập thất bại. Vui lòng thử lại.');
                        return;
                    }
                    const userData = res.content[0] ?? [];
                    loginSuccess(userData[1], userData[0]);
                } else if (otp === currentOTP) {
                    // Normal login
                    loginSuccess(user.accessToken, user.userId);
                } else {
                    showError('Mã OTP không đúng. Vui lòng thử lại.');
                }
            } catch (e) {
                console.log('Error', e);
                showError('Có lỗi xảy ra, vui lòng thử lại sau!');
            }
        }

        function loginSuccess(accessToken, userId) {
            localStorage.setItem('accessToken', `Bearer ${accessToken}`);
            localStorage.setItem('userId', userId);
            showMessage('Đăng nhập thành công!');
            setTimeout(() => window.location.href = 'map.html', 1000);
        }

        function showError(message) {
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-message').style.color = 'red';
        }

        function showMessage(message) {
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-message').style.color = 'green';
        }

        // Simulated API function
        async function getTokenByPhone(phone) {
            // This should be replaced with actual API call
            return new Promise(resolve => {
                setTimeout(() => {
                    resolve({
                        status_code: 200,
                        content: [['user123', 'token123']]
                    });
                }, 1000);
            });
        }
    </script></body></html>