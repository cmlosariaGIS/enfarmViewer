<!DOCTYPE html><html lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width, initial-scale=1.0"><link rel=stylesheet href=./login.css><title>Login to enfarm Enterprise Platform</title><link rel=icon href=https://i.ibb.co/tQDxF41/enfarm-favicon.png type=image/png><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Be+Vietnam:wght@400;500;700&display=swap"><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"><script src=https://kit.fontawesome.com/0eb73cfc5c.js crossorigin=anonymous></script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css><script src=https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.7.14/lottie.min.js></script></head><body onload=loadPage()><div class=form-container><img src=https://enfarm.com/fd57352e4cea98b4c1fb.jpg alt="enCity Logo" class=company-logo><p class=title data-translate=Welcome>Welcome</p><h6 class=sub-title data-translate="Login to access the enfarm Enterprise Platform">Login to access the enfarm Enterprise Platform</h6><br><form class=form onsubmit="event.preventDefault(); loginWithPhoneNumber();"><div class=input-container><input type=tel id=phone name=phone required><label for=phone data-translate="Mobile Number">Mobile Number</label><span class=phone-icon></span></div><div class=otp-input-container><div class=otp-boxes><input type=text class=otp-box maxlength=1 oninput="moveToNext(this, 0)" onkeydown="handleKeyDown(event, this, 0)"><input type=text class=otp-box maxlength=1 oninput="moveToNext(this, 1)" onkeydown="handleKeyDown(event, this, 1)"><input type=text class=otp-box maxlength=1 oninput="moveToNext(this, 2)" onkeydown="handleKeyDown(event, this, 2)"><input type=text class=otp-box maxlength=1 oninput="moveToNext(this, 3)" onkeydown="handleKeyDown(event, this, 3)"><input type=text class=otp-box maxlength=1 oninput="moveToNext(this, 4)" onkeydown="handleKeyDown(event, this, 4)"><input type=text class=otp-box maxlength=1 oninput="moveToNext(this, 5)" onkeydown="handleKeyDown(event, this, 5)"></div><button type=button id=generate-otp class=otp-btn onclick=handleSendOtp() data-translate="Generate OTP">Generate OTP</button></div><p id=error-message class=error-message></p><button type=submit class=form-btn data-translate="Log in">Log in</button></form></div><button id=lang-switch class=lang-switch onclick=toggleLanguage() aria-label="Toggle Language"> VN <i class="fa-solid fa-earth-asia"></i><span class=tooltip-bottom data-translate="Switch Language"></span></button><div id=modal class=modal><div class=modal-content><p id=modal-message></p></div></div><div id=hotline-icon class=hotline-icon aria-label="Call hotline 1800 888 900"><div id=lottie-container></div><div class=hotline-text-container><div class=hotline-text data-translate=Hotline>Hotline</div></div><span class=tooltip-left data-translate="Call 1800 888 900">Call 1800 888 900</span></div><script>
        //Login modal
        async function loginSuccess(accessToken, userId, userPhone) {
            localStorage.setItem('accessToken', `Bearer ${accessToken}`);
            localStorage.setItem('userId', userId);
            localStorage.setItem('userPhone', userPhone);
            showMessage(translations[currentLang]['Logged in successfully!']);

            try {
        const [userProfile, userThumbnail] = await Promise.all([
            getUserProfile(userId),
            getUserThumbnail(userId)
        ]);
        
        console.log('User profile:', userProfile);
        console.log('User thumbnail:', userThumbnail);

        if (userProfile.status_code === 200 && userProfile.content) {
            const userName = userProfile.content.user_name;
            // Change this line
            const thumbnailBase64 = userThumbnail.content;
            console.log('Thumbnail base64 before showModal:', thumbnailBase64);
            showModal('Logged in successfully!', userId, userName, thumbnailBase64);
        } else {
            showModal('Logged in successfully!', userId);
        }
    } catch (error) {
        console.error('Error fetching user data:', error);
        showModal('Logged in successfully!', userId);
    }
}

function showModal(messageKey, userId, userName = '', thumbnailBase64 = '') {
    console.log('Thumbnail base64:', thumbnailBase64);
    
    const modal = document.getElementById('modal');
    const modalMessage = document.getElementById('modal-message');

    const translatedMessage = translations[currentLang][messageKey] || messageKey;
    const welcomeMessage = translations[currentLang]['Welcome back'] || 'Welcome back';

    let fullMessage = '<div id="lottie-container" style="width: 60px; height: 60px; margin: 0 auto;"></div>';
    fullMessage += `<div>${translatedMessage}</div>`;
    fullMessage += `<div class="welcome-message">${welcomeMessage}</div>`;
    
    if (thumbnailBase64 && thumbnailBase64.startsWith('/9j/')) {
        console.log('Adding thumbnail to modal');
        fullMessage += `<img src="data:image/jpeg;base64,${thumbnailBase64}" alt="User Thumbnail" style="width: 50px; height: 50px; border-radius: 50%; margin: 10px auto; display: block;">`;
    } else {
        console.log('No thumbnail available');
        fullMessage += `<img src="https://via.placeholder.com/50" alt="User Thumbnail" style="width: 50px; height: 50px; border-radius: 50%; margin: 10px auto; display: block;">`;
    }
    
    if (userName) {
        fullMessage += `<div class="user-name">${userName}</div>`;
    } else {
        fullMessage += `<div class="user-name">${translations[currentLang]['User'] || 'User'}</div>`;
    }

    modalMessage.innerHTML = fullMessage;


            // Load and play the Lottie animation
            const animation = lottie.loadAnimation({
                container: document.getElementById('lottie-container'),
                renderer: 'svg',
                loop: true,
                autoplay: true,
                path: 'https://lottie.host/313c645e-ca52-48b4-acbb-b813f7728d8e/Z2Nev4y7fI.json'
            });

            // Adjust the animation speed if needed
            animation.setSpeed(1.5);

            modal.style.display = 'block';
            setTimeout(() => {
                modal.classList.add('show');
            }, 10);

            setTimeout(() => {
                closeModal();
            }, 3000); // 3 seconds display time
        }

        function closeModal() {
            const modal = document.getElementById('modal');
            modal.classList.remove('show');

            setTimeout(() => {
                modal.style.display = 'none';
                // Redirect to map.html after closing the modal
                window.location.href = 'map.html';
            }, 300); // Wait for the slide-up animation to complete
        }


        let currentLang = 'vi';
        const PHONE_TEST = ['0988515341', '0787989900', '0399043123', '0399058122', '0938239553', '055957790', '0905568999'];
        const TEST_PHONE_OTP = '123456';
        let currentOTP = '';
        let user = null;

        const translations = {
            'en': {
                'Welcome': 'Welcome',
                'Login to access the enfarm Enterprise Platform': 'Login to access the enfarm Enterprise Platform',
                'Log in': 'Log in',
                'Switch Language': 'Switch Language',
                'Mobile Number': 'Mobile Number',
                'Generate OTP': 'Generate OTP',
                'Logged in successfully!': 'Logged in successfully!',
                'An error occurred. Please try again later!': 'An error occurred. Please try again later!',
                'This phone number is not registered. Please call the hotline to register.': 'This phone number is not registered. Please call the hotline to register.',
                'OTP has been sent to phone number': 'OTP has been sent to phone number',
                'please confirm OTP to continue!': 'please confirm OTP to continue!',
                'Login failed. Please try again.': 'Login failed. Please try again.',
                'Incorrect OTP. Please try again.': 'Incorrect OTP. Please try again.',
                'Logged in successfully! User ID:': 'Logged in successfully! User ID:',
                'Hotline': 'Hotline',
                'Call 1800 888 900': 'Call 1800 888 900',
                'OTP sent to': 'OTP has been sent to phone number',
                'confirm OTP to continue': 'please confirm OTP to continue!',
                'Welcome back': 'Welcome back',
                'User': 'User',
            },
            'vi': {
                'Welcome': 'Chào mừng',
                'Login to access the enfarm Enterprise Platform': 'Đăng nhập để truy cập vào nền tảng doanh nghiệp enfarm',
                'Log in': 'Đăng nhập',
                'Switch Language': 'Đổi ngôn ngữ',
                'Mobile Number': 'Số điện thoại',
                'Generate OTP': 'Gửi mã OTP',
                'Logged in successfully!': 'Đăng nhập thành công!',
                'An error occurred. Please try again later!': 'Có lỗi xảy ra, vui lòng thử lại sau!',
                'This phone number is not registered. Please call the hotline to register.': 'Số điện thoại này chưa được đăng ký. Hãy gọi tới đường dây nóng để đăng ký',
                'OTP has been sent to phone number': 'Mã OTP đã được gửi đến số điện thoại',
                'please confirm OTP to continue!': 'vui lòng xác nhận OTP để tiếp tục!',
                'Login failed. Please try again.': 'Đăng nhập thất bại. Vui lòng thử lại.',
                'Incorrect OTP. Please try again.': 'Mã OTP không đúng. Vui lòng thử lại.',
                'Logged in successfully! User ID:': 'Đăng nhập thành công! ID người dùng:',
                'Hotline': 'Đường dây\nnóng', // Use \n for a line break
                'Call 1800 888 900': 'Gọi 1800 888 900',
                'OTP sent to': 'Mã OTP đã được gửi đến số điện thoại',
                'confirm OTP to continue': 'vui lòng xác nhận OTP để tiếp tục!',
                'Welcome back': 'Chào mừng trở lại',
                'User': 'Người dùng',
            }
        };

        function loadPage() {
            const urlParams = new URLSearchParams(window.location.search);
            const langParam = urlParams.get('lang');
            if (langParam && (langParam === 'en' || langParam === 'vi')) {
                currentLang = langParam;
            }
            translatePageTo(currentLang);
        }

        function toggleLanguage() {
            currentLang = currentLang === 'en' ? 'vi' : 'en';
            translatePageTo(currentLang);
            const url = new URL(window.location);
            url.searchParams.set('lang', currentLang);
            window.history.pushState({}, '', url);
        }

        function translatePageTo(lang) {
            currentLang = lang;
            const elements = document.querySelectorAll('[data-translate]');
            const langSwitchButton = document.getElementById('lang-switch');

            langSwitchButton.innerHTML = lang === 'en' ? 'VN <i class="fa-solid fa-earth-asia"></i>' : 'EN <i class="fa-solid fa-earth-americas"></i>';

            elements.forEach(element => {
                const key = element.getAttribute('data-translate');
                if (element.tagName === 'INPUT') {
                    element.placeholder = translations[lang][key] || element.placeholder;
                } else {
                    element.innerText = translations[lang][key] || element.innerText;
                }
            });

            updateDynamicMessages();
        }

        function moveToNext(field, index) {
            if (field.value.length >= field.maxLength) {
                if (index < 5) {
                    document.getElementsByClassName('otp-box')[index + 1].focus();
                }
            }
        }

        //Allow users to backspace normally without having to manually move between boxes.
        function handleKeyDown(event, field, index) {
            if (event.key === 'Backspace') {
                event.preventDefault();
                if (field.value.length > 0) {
                    field.value = '';
                } else if (index > 0) {
                    const previousField = document.getElementsByClassName('otp-box')[index - 1];
                    previousField.focus();
                    previousField.value = '';
                }
            }
        }

        async function handleSendOtp() {
            const phoneNumber = document.getElementById('phone').value;
            const formattedPhoneNumber = phoneNumber.replace(/\s+/g, ''); // Remove all spaces
            try {
                if (formattedPhoneNumber === '1800888900') {
                    // Special handling for admin number
                    user = { userId: 'admin', accessToken: 'admin_token' };
                    sessionStorage.setItem('userId', user.userId);
                    sessionStorage.setItem('userPhone', phoneNumber);
                    console.log('Admin login initiated');
                    currentOTP = TEST_PHONE_OTP; // Use the test OTP for admin
                    showMessage(`${translations[currentLang]['OTP sent to']} ${phoneNumber}, ${translations[currentLang]['confirm OTP to continue']}`);
                } else {
                    const res = await getTokenByPhone(phoneNumber);
                    if (res.status_code !== 200) {
                        showError('An error occurred. Please try again later!');
                        return;
                    }
                    if (res.content && res.content.length === 0) {
                        showError('This phone number is not registered. Please call the hotline to register.');
                        return;
                    }
                    const userData = res.content[0] ?? [];
                    user = { userId: userData[0], accessToken: userData[1] };
                    sessionStorage.setItem('userId', user.userId);
                    sessionStorage.setItem('userPhone', phoneNumber);
                    console.log('User ID:', user.userId);
                    currentOTP = TEST_PHONE_OTP; // Use the test OTP
                    showMessage(`${translations[currentLang]['OTP sent to']} ${phoneNumber}, ${translations[currentLang]['confirm OTP to continue']}`);
                }

                document.getElementById('generate-otp').disabled = true;
                setTimeout(() => {
                    document.getElementById('generate-otp').disabled = false;
                }, 60000);
            } catch (e) {
                console.log('Error', e);
                showError('An error occurred. Please try again later!');
            }
        }

        async function loginWithPhoneNumber() {
            const phoneNumber = document.getElementById('phone').value;
            const formattedPhoneNumber = phoneNumber.replace(/\s+/g, ''); // Remove all spaces
            const otpBoxes = document.getElementsByClassName('otp-box');
            const otp = Array.from(otpBoxes).map(box => box.value).join('');

            try {
                if (otp === TEST_PHONE_OTP) {
                    if (formattedPhoneNumber === '1800888900') {
                        // Admin login
                        loginSuccess('admin_token', 'admin', phoneNumber);
                    } else {
                        const res = await getTokenByPhone(phoneNumber);
                        if (res.status_code !== 200 || (res.content && res.content.length === 0)) {
                            showError('Login failed. Please try again.');
                            return;
                        }
                        const userData = res.content[0] ?? [];
                        const userId = userData[0];
                        const userToken = userData[1];
                        loginSuccess(userToken, userId, phoneNumber);
                    }
                } else {
                    showError('Incorrect OTP. Please try again.');
                }
            } catch (e) {
                console.log('Error', e);
                showError('An error occurred. Please try again later!');
            }
        }

        async function getTokenByPhone(phone) {
            try {
                // Format the phone number
                const formattedPhone = "+84 " + phone.replace(/^0/, '');
                const response = await fetch('https://api.enfarm.com/user_token_get', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ UserMobile: formattedPhone }),
                });
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error calling API:', error);
                throw error;
            }
        }

        function showError(messageKey) {
            const errorElement = document.getElementById('error-message');
            errorElement.textContent = translations[currentLang][messageKey] || messageKey;
            errorElement.style.color = 'red';
            errorElement.dataset.messageKey = messageKey;
        }

        function showMessage(message) {
            const errorElement = document.getElementById('error-message');
            errorElement.textContent = message;
            errorElement.style.color = 'green';
            errorElement.dataset.messageKey = 'custom';
        }


        function updateDynamicMessages() {
            const phoneNumber = document.getElementById('phone').value;
            const errorMessage = document.getElementById('error-message');

            if (errorMessage.textContent.includes(translations[currentLang === 'en' ? 'vi' : 'en']['OTP sent to'])) {
                showMessage(`${translations[currentLang]['OTP sent to']} ${phoneNumber}, ${translations[currentLang]['confirm OTP to continue']}`);
            } else if (errorMessage.textContent === translations[currentLang === 'en' ? 'vi' : 'en']['This phone number is not registered. Please call the hotline to register.']) {
                showError('This phone number is not registered. Please call the hotline to register.');
            }
            // Add other dynamic messages here if needed
        }

        /*** Phone Hotline ***/
        document.addEventListener('DOMContentLoaded', function () {
            const hotlineIcon = document.getElementById('hotline-icon');
            const animation = lottie.loadAnimation({
                container: document.getElementById('lottie-container'),
                renderer: 'svg',
                loop: true,
                autoplay: true,
                path: 'https://lottie.host/dec81b00-2f44-49aa-bf4c-83212df6a3bd/EYfMc8te1X.json'
            });

            hotlineIcon.addEventListener('click', function () {
                // Initiate call to 1800 888 900
                window.location.href = 'tel:1800888900';
            });
        });


        /*User Profile*/

        async function getUserProfile(userId) {
            try {
                const response = await fetch('https://api-router.enfarm.com/api/v2/user/get-user-profile', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ user_id: userId }),
                });
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error fetching user profile:', error);
                throw error;
            }
        }


        /*User Thumbnail*/
        async function getUserThumbnail(userId) {
            try {
                const response = await fetch('https://api-router.enfarm.com/api/v2/user/get-user-thumbnail', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ user_id: userId }),
                });
                const data = await response.json();
                console.log('Thumbnail response:', data); // Add this line
                return data;
            } catch (error) {
                console.error('Error fetching user thumbnail:', error);
                throw error;
            }
        }


    </script></body></html>