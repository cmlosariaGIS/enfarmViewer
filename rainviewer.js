L.Control.Rainviewer=L.Control.extend({onAdd:function(map){this.timestamps=[];this.radarLayers=[];this.currentTimestamp;this.nextTimestamp;this.animationPosition=0;this.animationTimer=false;this.rainviewerActive=false;this._map=map;this.container=L.DomUtil.create('div','leaflet-control-rainviewer leaflet-bar leaflet-control');this.link=L.DomUtil.create('a','leaflet-control-rainviewer-button leaflet-bar-part',this.container);this.link.href='#';L.DomEvent.on(this.link,'click',this.load,this);return this.container;},load:function(map){var realTimeText=L.DomUtil.create('div','real-time-text',this.container);realTimeText.textContent=getTranslatedText("Real-time Radar Data");realTimeText.style.fontSize='14px';realTimeText.style.textAlign='center';realTimeText.style.paddingBottom='20px';realTimeText.style.fontFamily="'Be Vietnam', sans-serif";realTimeText.style.textShadow='1px 1px 2px rgba(0,0,0,0.5)';var t=this;this.apiRequest=new XMLHttpRequest();this.apiRequest.open("GET","https://api.rainviewer.com/public/weather-maps.json",true);this.apiRequest.onload=function(e){var response=JSON.parse(t.apiRequest.response);t.timestamps=response.radar.past.concat(response.radar.nowcast);t.timestamps.sort((a,b)=>a.time-b.time);t.positionSlider.max=t.timestamps.length-1;console.log(t.timestamps);t.showFrame(-1);};this.apiRequest.send();L.DomUtil.addClass(this.container,'leaflet-control-rainviewer-active');this.controlContainer=L.DomUtil.create('div','leaflet-control-rainviewer-container',this.container);this.prevButton=L.DomUtil.create('input','leaflet-control-rainviewer-prev leaflet-bar-part btn',this.controlContainer);this.prevButton.type="button";this.prevButton.value=this.options.prevButtonText;L.DomEvent.on(this.prevButton,'click',t.prev,this);L.DomEvent.disableClickPropagation(this.prevButton);this.startstopButton=L.DomUtil.create('input','leaflet-control-rainviewer-startstop leaflet-bar-part btn',this.controlContainer);this.startstopButton.type="button";this.startstopButton.value=this.options.playStopButtonText;L.DomEvent.on(this.startstopButton,'click',t.startstop,this);L.DomEvent.disableClickPropagation(this.startstopButton);this.nextButton=L.DomUtil.create('input','leaflet-control-rainviewer-next leaflet-bar-part btn',this.controlContainer);this.nextButton.type="button";this.nextButton.value=this.options.nextButtonText;L.DomEvent.on(this.nextButton,'click',t.next,this);L.DomEvent.disableClickPropagation(this.nextButton);this.positionSliderLabel=L.DomUtil.create('label','leaflet-control-rainviewer-label leaflet-bar-part',this.controlContainer);this.positionSliderLabel.for="rainviewer-positionslider";this.positionSliderLabel.textContent=getTranslatedText("Adjust time:");this.positionSlider=L.DomUtil.create('input','leaflet-control-rainviewer-positionslider leaflet-bar-part',this.controlContainer);this.positionSlider.type="range";this.positionSlider.id="rainviewer-positionslider";this.positionSlider.min=0;this.positionSlider.max=11;this.positionSlider.value=this.animationPosition;L.DomEvent.on(this.positionSlider,'input',t.setPosition,this);L.DomEvent.disableClickPropagation(this.positionSlider);const positionSlider=document.querySelector('.leaflet-control-rainviewer-positionslider');const positionInitialValue=(positionSlider.value-positionSlider.min)/(positionSlider.max-positionSlider.min)*100;positionSlider.style.setProperty('--value',`${positionInitialValue}%`);const setPositionValue=()=>{const val=((positionSlider.value-positionSlider.min)/(positionSlider.max-positionSlider.min))*100;positionSlider.style.setProperty('--value',`${val}%`);}
window.addEventListener('load',setPositionValue);positionSlider.addEventListener('input',setPositionValue);this.closeButton=L.DomUtil.create('div','leaflet-control-rainviewer-close',this.container);L.DomEvent.on(this.closeButton,'click',t.unload,this);var html='<div id="timestamp" class="leaflet-control-rainviewer-timestamp"></div>';this.controlContainer.insertAdjacentHTML('beforeend',html);L.DomEvent.disableClickPropagation(this.controlContainer);this.opacitySliderLabel=L.DomUtil.create('label','leaflet-control-rainviewer-label leaflet-bar-part',this.controlContainer);this.opacitySliderLabel.for="rainviewer-opacityslider";this.opacitySliderLabel.textContent=getTranslatedText("Adjust layer opacity:");this.opacitySlider=L.DomUtil.create('input','leaflet-control-rainviewer-opacityslider leaflet-bar-part',this.controlContainer);this.opacitySlider.type="range";this.opacitySlider.id="rainviewer-opacityslider";this.opacitySlider.min=0;this.opacitySlider.max=100;this.opacitySlider.value=this.options.opacity*100;L.DomEvent.on(this.opacitySlider,'input',t.setOpacity,this);L.DomEvent.disableClickPropagation(this.opacitySlider);const opacitySlider=document.querySelector('.leaflet-control-rainviewer-opacityslider');const opacityInitialValue=(opacitySlider.value-opacitySlider.min)/(opacitySlider.max-opacitySlider.min)*100;opacitySlider.style.setProperty('--value',`${opacityInitialValue}%`);const setOpacityValue=()=>{const val=((opacitySlider.value-opacitySlider.min)/(opacitySlider.max-opacitySlider.min))*100;opacitySlider.style.setProperty('--value',`${val}%`);}
opacitySlider.addEventListener('input',setOpacityValue);this.sourceText=L.DomUtil.create('div','leaflet-control-rainviewer-source',this.controlContainer);this.sourceText.textContent=getTranslatedText("Source")+': RainViewer';this.sourceText.style.fontSize='10px';this.sourceText.style.textAlign='center';this.sourceText.style.marginTop='20px';this.sourceText.style.color='#fffff';},unload:function(e){var realTimeText=this.container.querySelector('.real-time-text');if(realTimeText){this.container.removeChild(realTimeText);}
L.DomUtil.remove(this.controlContainer);L.DomUtil.remove(this.closeButton);L.DomUtil.removeClass(this.container,'leaflet-control-rainviewer-active');var radarLayers=this.radarLayers;var map=this._map;Object.keys(radarLayers).forEach(function(key){if(map.hasLayer(radarLayers[key])){map.removeLayer(radarLayers[key]);}});},addLayer:function(ts){var map=this._map;if(!this.radarLayers[ts.time]){var url=this.options.host+ts.path+'/256/{z}/{x}/{y}/2/1_1.png';this.radarLayers[ts.time]=new L.TileLayer(url,{tileSize:256,opacity:0.001,transparent:true,attribution:'<a href="https://rainviewer.com" target="_blank">rainviewer.com</a>',zIndex:ts.time});}
if(!map.hasLayer(this.radarLayers[ts.time])){map.addLayer(this.radarLayers[ts.time]);}},changeRadarPosition:function(position,preloadOnly){while(position>=this.timestamps.length){position-=this.timestamps.length;}
while(position<0){position+=this.timestamps.length;}
this.currentTimestamp=this.timestamps[this.animationPosition];this.nextTimestamp=this.timestamps[position];this.addLayer(this.nextTimestamp);if(preloadOnly){return;}
this.animationPosition=position;this.positionSlider.value=position;this.updatePositionSlider();if(this.radarLayers[this.currentTimestamp.time]){this.radarLayers[this.currentTimestamp.time].setOpacity(0);}
this.radarLayers[this.nextTimestamp.time].setOpacity(this.options.opacity);var currentTime=Math.floor(Date.now()/1000);var date=new Date(this.nextTimestamp.time*1000);var formattedTime=date.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});var timeDiff=Math.round((this.nextTimestamp.time-currentTime)/60);var timeString=formattedTime;if(timeDiff>0){timeString+=' ('+getTranslatedText("Forecast")+' +'+timeDiff+' '+getTranslatedText("min")+')';}else if(timeDiff<0){timeString+=' ('+getTranslatedText("Past")+' '+Math.abs(timeDiff)+' '+getTranslatedText("min ago")+')';}else{timeString+=' ('+getTranslatedText("Current")+')';}
document.getElementById("timestamp").innerHTML=timeString;},updatePositionSlider:function(){var percentage=(this.animationPosition/(this.timestamps.length-1))*100;this.positionSlider.style.background='linear-gradient(to right, #00ff00 0%, #00ff00 '+percentage+'%, #fff '+percentage+'%, white 100%)';},showFrame:function(nextPosition){var preloadingDirection=nextPosition-this.animationPosition>0?1:-1;this.changeRadarPosition(nextPosition);this.changeRadarPosition(nextPosition+preloadingDirection,true);},setOpacity:function(e){this.options.opacity=e.target.value/100;if(this.radarLayers[this.currentTimestamp.time]){this.radarLayers[this.currentTimestamp.time].setOpacity(this.options.opacity);}},setPosition:function(e){this.showFrame(parseInt(e.target.value));},stop:function(){if(this.animationTimer){clearTimeout(this.animationTimer);this.animationTimer=false;return true;}
return false;},play:function(){this.showFrame(this.animationPosition+1);this.animationTimer=setTimeout(function(){this.play()}.bind(this),this.options.animationInterval);},playStop:function(){if(!this.stop()){this.play();}},prev:function(e){L.DomEvent.stopPropagation(e);L.DomEvent.preventDefault(e);this.stop();this.showFrame(this.animationPosition-1);return},startstop:function(e){L.DomEvent.stopPropagation(e);L.DomEvent.preventDefault(e);this.playStop()},next:function(e){L.DomEvent.stopPropagation(e);L.DomEvent.preventDefault(e);this.stop();this.showFrame(this.animationPosition+1);return},onRemove:function(map){}});L.control.rainviewer=function(opts){return new L.Control.Rainviewer(opts);}